# Build using Visual Studio 2017 on Windows Server 2016.
# Variables with password stored in Azure secrets

trigger: none

pool:
  name: Wooli Rough

variables:
  build_cake: './src/build.cake'
  quotes_regexp: '"([^"]+)"'
  publishingTargetDir_String: '\s*publishingTargetDir: $(quotes_regexp)\s*'
  scSiteUrl_String: '\s*scSiteUrl: $(quotes_regexp)\s*'

steps:

#- task: PowerShell@2
#  inputs:
#    targetType: 'inline'
#    script: '(Invoke-WebRequest -uri "https://api.ipify.org/").Content'
#  displayName: Check agent IP address

- task: UseNode@1
  inputs:
    script: '"C:\Program Files\nodejs\npm.cmd" --version'
  displayName: Installing Node 10

- task: DownloadSecureFile@1
  name: license_file
  inputs:
    secureFile: 'license.xml'
  displayName: Download license

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      (Get-Content $(build_cake)) -replace "MSBuildToolVersion.VS201\d{1,3}", $(agent_buildTools) | Set-Content $(build_cake)
      (Get-Content $(build_cake)) -replace '$(publishingTargetDir_String)', $(publishingTargetDir) | Set-Content $(build_cake)
      (Get-Content $(build_cake)) -replace '$(scSiteUrl_String)', $(scSiteUrl) | Set-Content $(build_cake)
      move /Y $(license_file.secureFilePath) ./src/
  displayName: Config preparation

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      cmdkey /add:$(HOST_NETWORK_ADDRESS) /user:$(user_name) /pass:$(user_password)
  displayName: Add windows credentials to agent

- task: PowerShell@2
  inputs:
    filePath: './src/build.ps1'
    errorActionPreference: 'continue'
    workingDirectory: './src/'
  displayName: Build
  continueOnError: true

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: 'copy ./src/build.ps1 c:\vagrant\src -Force -Recurse'
    errorActionPreference: 'continue'
  displayName: Copy src for Wooli-Unicorn

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: 'cmdkey /delete:$env:HOST_NETWORK_ADDRESS'
  displayName: Remove windows credentials from agent
  condition: always()